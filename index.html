<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>роЕрогрпНрогро╛ роЕро░роЪрпБ рооро╛родро┐ро░ро┐ роорпЗро▓рпНроиро┐ро▓рпИ рокро│рпНро│ро┐ тАФ родро┐ройроЪро░ро┐ родрооро┐ро┤рпН роЪрпЖропрпНродро┐роХро│рпН</title>

<!-- Noto Sans Tamil webfont (used for on-screen & for html2pdf rendering) -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">

<!-- html2pdf bundle (includes html2canvas + jspdf) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --accent:#2b6cb0;
    --bg:#f0f7ff;
    --card:#ffffff;
    --muted:#55616a;
  }
  html,body{height:100%; margin:0; padding:0; background:var(--bg); font-family:"Noto Sans Tamil", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#0b1220;}
  header{
    background:var(--accent);
    color:#fff;
    padding:18px 12px;
    text-align:center;
    font-size:20px;
    font-weight:700;
  }
  .subheader{
    text-align:center;
    padding:10px 12px;
    color:#083358;
    font-weight:600;
  }
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    padding:12px;
  }
  button, input[type=range]{
    font-size:15px;
    padding:8px 12px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.08);
    background:var(--accent);
    color:#fff;
    cursor:pointer;
  }
  button.ghost{background:#fff; color:var(--accent); border:1px solid rgba(43,91,165,0.12);}
  #speedWrap{display:flex; align-items:center; gap:8px; background:transparent; border:none;}
  #newsWrap{max-width:900px; margin:12px auto; padding:12px;}
  section{margin-top:8px;}
  .sectionTitle{font-size:18px; font-weight:700; color:var(--accent); margin:8px 0 12px; border-bottom:2px solid rgba(43,91,165,0.08); padding-bottom:6px;}
  .card{
    background:var(--card);
    border-radius:10px;
    padding:14px;
    box-shadow: 0 6px 14px rgba(15,30,50,0.06);
    margin-bottom:12px;
  }
  .title{font-weight:700; font-size:16px; margin-bottom:6px; color:#0b1220;}
  .desc{font-size:14px; color:var(--muted); line-height:1.35; margin-bottom:8px;}
  .meta{font-size:12px; color:#7a8a93;}
  a.readmore{display:inline-block; margin-top:8px; color:var(--accent); text-decoration:none; font-weight:600;}
  /* printable area styles (used for PDF) */
  #printable{
    font-family:"Noto Sans Tamil", sans-serif;
    color:#0b1220;
    padding:18px;
  }
  #printable h1{font-size:20px; margin:6px 0 12px; text-align:center;}
  #printable .pdCard{border-radius:6px; padding:10px; margin:8px 0; border:1px solid #e6eefb;}
  /* small screens */
  @media (max-width:480px){
    header{font-size:18px; padding:14px;}
    .title{font-size:15px;}
    .desc{font-size:13px;}
    button{padding:10px 12px; font-size:14px;}
  }
</style>
</head>
<body>
<header>ЁЯУЪ роЕрогрпНрогро╛ роЕро░роЪрпБ рооро╛родро┐ро░ро┐ роорпЗро▓рпНроиро┐ро▓рпИ рокро│рпНро│ро┐ тАФ родро┐ройроЪро░ро┐ родрооро┐ро┤рпН роЪрпЖропрпНродро┐роХро│рпН</header>
<div class="subheader">рооро╛рогро╡ро░рпНроХро│рпБроХрпНроХрпБрокрпН рокрпКро░рпБродрпНродрооро╛рой роЪрпЖропрпНродро┐роХро│рпН тАФ роХро▓рпНро╡ро┐, роЕро▒ро┐ро╡ро┐ропро▓рпН, ро╡ро┐ро│рпИропро╛роЯрпНроЯрпБ, ро╡ро┐ро░рпБродрпБроХро│рпН, роЪрпБро▒рпНро▒рпБроЪрпНроЪрпВро┤ро▓рпН</div>

<div class="controls" aria-hidden="false">
  <button id="playBtn">ЁЯФК роиро┐роХро┤рпН роЪрпЖропрпНродро┐ропрпИ рокроЯро┐роХрпНроХ</button>
  <button id="pauseBtn" class="ghost">тП╕ роиро┐ро▒рпБродрпНрод</button>
  <button id="resumeBtn" class="ghost">тЦ╢ родрпКроЯро░рпНроХрпНроХ</button>
  <button id="stopBtn" class="ghost">тП╣ роиро┐ро▒рпБродрпНродрпБ</button>

  <div id="speedWrap" style="margin-left:6px;">
    <label style="color:#083358;font-weight:600;">ро╡рпЗроХроорпН</label>
    <input id="speedRange" type="range" min="0.7" max="1.3" step="0.05" value="0.95" style="margin-left:8px;">
    <span id="speedLabel" style="color:#083358;margin-left:6px;">0.95├Ч</span>
  </div>

  <button id="pdfBtn">ЁЯУД PDF рокродро┐ро╡ро┐ро▒роХрпНроХ</button>
  <button id="refreshBtn" class="ghost" title="роЪрпЖропрпНродро┐роХро│рпИ роорпАро│рпБрокродро┐ро╡рпБ">ЁЯФД рокрпБродрпБрокрпНрокро┐</button>
</div>

<div id="newsWrap">
  <div id="news">роЪрпЖропрпНродро┐роХро│рпНуГнуГ╝уГЙф╕нтАж</div>
</div>

<!-- Hidden printable element used for PDF generation -->
<div id="printable" style="display:none;"></div>

<script>
/* ============================
   Tamil-only feeds (tested)
   ============================ */
const FEEDS = [
  "https://www.dinamani.com/feeds/?id=Home",                 // Dinamani (home)
  "https://www.dinamani.com/education/feeder/default.rss",   // Dinamani education
  "https://www.hindutamil.in/rss",                           // Hindutamil
  "https://www.puthiyathalaimurai.com/rss/ta",               // Puthiya Thalaimurai
  "https://www.maalaimalar.com/rss/ta"                       // Maalai Malar
];

/* ============================
   Student-friendly filter (Tamil)
   ============================ */
function filterStudentNews(arr) {
  const bad = [
    "роХрпКро▓рпИ","роХрпКро▓рпНро▓рпИ","родро┐ро░рпБроЯрпН","родро┐ро░рпБроЯрпНроЯрпБ","ро╡ройрпНроорпБро▒рпИ","роЕро╡ро▓роорпН","родро▒рпНроХрпКро▓рпИ",
    "роЕроЯрпНроЯро╛","роЕроЯро┐родрпНродрпБ","роХрпБрогрпНроЯрпБ","родро╛роХрпНроХрпБродро▓рпН","роЪрогрпНроЯрпИ","роХрпБро▒рпНро▒роорпН","родро▒рпНроХрпКро▓рпИ",
    "ро╡рпЖро▒рпБро╖роорпН","роЕро░роЪро┐ропро▓рпН","родрпЗро░рпНро╡рпБ роорпБроЯро┐ро╡рпБроХро│рпН (negative context?)"
  ].map(s=>s.toLowerCase());

  const allowTags = [
    "роХро▓рпНро╡ро┐","рооро╛рогро╡ро░рпН","рооро╛рогро╡ро░рпНроХро│рпН","рокро│рпНро│ро┐","родрпЗро░рпНро╡рпБ","рокро╛роЯроорпН","ро╡ро┐ро┤ро╛","ро╡ро┐ро│рпИропро╛роЯрпНроЯрпБ","ро╡рпЖро▒рпНро▒ро┐",
    "рокродроХрпНроХроорпН","ро╡ро┐ро░рпБродрпБ","роЕро▒ро┐ро╡ро┐ропро▓рпН","родрпКро┤ро┐ро▓рпНроирпБроЯрпНрокроорпН","роЗро╕рпНро░рпЛ","ро╡ро┐рогрпНро╡рпЖро│ро┐","роЖроЪро┐ро░ро┐ропро░рпН",
    "родрпКроЯроХрпНроХроорпН","рокрпБродро┐роп","роЖро╡рпЗро╖роорпН","роЪрпБро▒рпНро▒рпБроЪрпНроЪрпВро┤ро▓рпН","рокрпБродрпНродроХроорпН","роирпБроЯрпНрокроорпН","роЖропрпНро╡рпБ","ро░рпВроЯрпНроЯро┐ройрпН"
  ].map(s=>s.toLowerCase());

  return arr.filter(item => {
    const t = (item.title + " " + item.description).toLowerCase();

    // Exclude if any bad word present
    for (const b of bad) if (t.includes(b)) return false;

    // Prefer items that include at least one allowed tag OR are neutral
    for (const g of allowTags) if (t.includes(g)) return true;

    // If neither allowed nor banned, still allow (so we don't become too strict),
    // but we can deprioritize later. For now include.
    return true;
  });
}

/* ============================
   RSS -> JSON via rss2json (public proxy)
   Note: rss2json has rate limits but works for basic usage.
   ============================ */
async function fetchFeedAsJson(url) {
  const api = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(url);
  try {
    const r = await fetch(api);
    if (!r.ok) return [];
    const j = await r.json();
    if (!j.items) return [];
    return j.items.map(it => ({
      title: it.title || "",
      description: (it.description || "").replace(/<\/?[^>]+(>|$)/g, ""), // strip html
      link: it.link || "",
      pubDate: it.pubDate || "",
      source: (j.feed && j.feed.title) ? j.feed.title : (new URL(url)).host
    }));
  } catch (e) {
    console.warn("feed fetch failed", url, e);
    return [];
  }
}

async function loadAll() {
  // fetch all feeds in parallel (but handle failures gracefully)
  const promises = FEEDS.map(f => fetchFeedAsJson(f));
  const lists = await Promise.all(promises);

  // flatten & dedupe by title
  const flat = lists.flat();
  const seen = new Set();
  const uniq = [];
  for (const it of flat) {
    const key = (it.title || "").trim();
    if (!key) continue;
    if (seen.has(key)) continue;
    seen.add(key);
    uniq.push(it);
  }

  // sort by pubDate desc if available
  uniq.sort((a,b) => {
    const da = a.pubDate ? new Date(a.pubDate).getTime() : 0;
    const db = b.pubDate ? new Date(b.pubDate).getTime() : 0;
    return db - da;
  });

  // apply filter
  const filtered = filterStudentNews(uniq);

  // return top 30 or less
  return filtered.slice(0, 30);
}

/* ============================
   Render on page
   ============================ */
function renderNews(list) {
  const container = document.getElementById("news");
  container.innerHTML = "";

  if (!list.length) {
    container.innerHTML = "<p style='text-align:center;color:#55616a;'>роЪрпЖропрпНродро┐роХро│рпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ. рокрпБродрпБрокрпНрокро┐рокрпНрокрпБроХрпН роХрпЛро░рпБроЩрпНроХро│рпН.</p>";
    return;
  }

  // We create three logical sections: Education (if any), Sports, General
  // But for simplicity, show single list grouped by recency
  const sec = document.createElement("section");
  const heading = document.createElement("div");
  heading.className = "sectionTitle";
  heading.textContent = "роЪроорпАрокродрпНродро┐роп роЪрпЖропрпНродро┐роХро│рпН";
  sec.appendChild(heading);

  list.forEach(item => {
    const card = document.createElement("article");
    card.className = "card";
    const t = document.createElement("div");
    t.className = "title";
    t.textContent = item.title;
    const d = document.createElement("div");
    d.className = "desc";
    d.textContent = item.description;
    const m = document.createElement("div");
    m.className = "meta";
    const dateStr = item.pubDate ? ("родрпЗродро┐: " + new Date(item.pubDate).toLocaleString("ta-IN")) : "";
    m.textContent = `${item.source} тАв ${dateStr}`;
    const read = document.createElement("a");
    read.className = "readmore";
    read.href = item.link || "#";
    read.target = "_blank";
    read.rel = "noopener";
    read.textContent = "роорпЗро▓рпБроорпН рокроЯро┐роХрпНроХ тЖЧ";

    card.appendChild(t);
    card.appendChild(d);
    card.appendChild(m);
    card.appendChild(read);
    sec.appendChild(card);
  });

  container.appendChild(sec);
}

/* ============================
   Text-to-Speech (Tamil)
   ============================ */
let allVoices = [];
function loadVoices(){ allVoices = window.speechSynthesis.getVoices(); }
window.speechSynthesis.onvoiceschanged = loadVoices;

function getTamilVoice() {
  if (!allVoices.length) loadVoices();
  // try to find ta-IN voice
  const taVoice = allVoices.find(v => v.lang && v.lang.toLowerCase().startsWith("ta"));
  if (taVoice) return taVoice;
  // fallback: any voice that speaks en-IN (works poorly), or first voice
  return allVoices.find(v => v.lang && v.lang.toLowerCase().startsWith("en-in")) || allVoices[0];
}

function buildScriptFromDOM() {
  // Gather title + each card's title + first sentence of desc
  const parts = [];
  const header = "роирогрпНрокро░рпНроХро│рпЗ. роЗродрпЛ роЙроЩрпНроХро│рпН рокро│рпНро│ро┐ роЪрпЖропрпНродро┐ ро╡рпЖро│ро┐ропрпАроЯрпБ.";
  parts.push(header);
  document.querySelectorAll(".card").forEach((c, idx) => {
    const ti = c.querySelector(".title")?.innerText || "";
    const de = c.querySelector(".desc")?.innerText || "";
    // take first sentence from desc
    const first = (de.split(/[\.\?\!]\s/)[0] || "").trim();
    if (ti) parts.push(`${idx+1}. ${ti}. ${first}`);
  });
  parts.push("роЗро╡рпИропро╛ро▓рпН роЙроЩрпНроХро│рпБроХрпНроХрпБрокрпН рокропройро╛роХро╡ро╛роХроЯрпНроЯрпБроорпН. роЪро┐ро▒роирпНрод роиро╛ро│ро╛роХ роЗро░рпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.");
  return parts.join(". ");
}

let currentUtters = [];
function speakAll(rate=0.95) {
  window.speechSynthesis.cancel();
  const voice = getTamilVoice();
  const text = buildScriptFromDOM();
  if (!text) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ta-IN";
  if (voice) u.voice = voice;
  u.rate = rate;
  u.pitch = 1.0;
  window.speechSynthesis.speak(u);
  currentUtters = [u];
}

/* ============================
   PDF generation using html2pdf
   Ensures Tamil renders correctly by using the page's webfont.
   ============================ */
function preparePrintable(list) {
  // Build printable HTML with title + items
  const printable = document.getElementById("printable");
  printable.style.display = "block"; // make visible for accurate rendering
  printable.innerHTML = "";

  const h = document.createElement("h1");
  h.textContent = "роЕрогрпНрогро╛ роЕро░роЪрпБ рооро╛родро┐ро░ро┐ роорпЗро▓рпНроиро┐ро▓рпИ рокро│рпНро│ро┐ тАФ родро┐ройроЪро░ро┐ родрооро┐ро┤рпН роЪрпЖропрпНродро┐роХро│рпН";
  printable.appendChild(h);

  const metaLine = document.createElement("div");
  metaLine.style.textAlign = "center";
  metaLine.style.marginBottom = "8px";
  metaLine.style.color = "#334c67";
  metaLine.textContent = new Date().toLocaleDateString("ta-IN", { year:"numeric", month:"long", day:"numeric" });
  printable.appendChild(metaLine);

  list.forEach((it, idx) => {
    const box = document.createElement("div");
    box.className = "pdCard";
    const tt = document.createElement("div");
    tt.style.fontWeight = "700";
    tt.style.marginBottom = "6px";
    tt.textContent = `${idx+1}. ${it.title}`;
    const dd = document.createElement("div");
    dd.textContent = it.description || "";
    const mm = document.createElement("div");
    mm.style.color = "#55616a";
    mm.style.marginTop = "6px";
    mm.style.fontSize = "12px";
    mm.textContent = `${it.source} тАв ${it.pubDate ? new Date(it.pubDate).toLocaleString("ta-IN") : ""}`;
    box.appendChild(tt);
    box.appendChild(dd);
    box.appendChild(mm);
    printable.appendChild(box);
  });

  return printable;
}

async function generatePDF(list) {
  if (!list || !list.length) {
    alert("рокродро┐ро╡ро┐ро▒роХрпНроХродрпНродро┐ро▒рпНроХрпБ рокрпЛродрпБрооро╛рой роЪрпЖропрпНродро┐роХро│рпН роЗро▓рпНро▓рпИ.");
    return;
  }
  const printable = preparePrintable(list);

  // html2pdf options: set margin, filename, and use dpi to improve clarity on mobile
  const opt = {
    margin:       [10, 10, 10, 10],
    filename:     `Tamil_News_${new Date().toLocaleDateString('en-CA')}.pdf`,
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 2, useCORS: true, dpi: 300, letterRendering: 1 },
    jsPDF:        { unit: 'pt', format: 'a4', orientation: 'portrait' }
  };

  try {
    await html2pdf().set(opt).from(printable).save();
  } catch (e) {
    console.error("PDF creation failed", e);
    alert("PDF родропро╛ро░ро┐рокрпНрокродро┐ро▓рпН рокро┐ро┤рпИ роПро▒рпНрокроЯрпНроЯродрпБ. рокро┐ро▒роХрпБ роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.");
  } finally {
    // hide printable again
    printable.style.display = "none";
  }
}

/* ============================
   Init & event wiring
   ============================ */
let latestList = [];

async function init() {
  const play = document.getElementById("playBtn");
  const pause = document.getElementById("pauseBtn");
  const resume = document.getElementById("resumeBtn");
  const stop = document.getElementById("stopBtn");
  const speedRange = document.getElementById("speedRange");
  const speedLabel = document.getElementById("speedLabel");
  const pdfBtn = document.getElementById("pdfBtn");
  const refresh = document.getElementById("refreshBtn");

  speedRange.addEventListener("input", ()=> {
    speedLabel.textContent = parseFloat(speedRange.value).toFixed(2) + "├Ч";
  });

  play.addEventListener("click", ()=> {
    const r = parseFloat(speedRange.value) || 0.95;
    speakAll(r);
  });
  pause.addEventListener("click", ()=> { window.speechSynthesis.pause(); });
  resume.addEventListener("click", ()=> { window.speechSynthesis.resume(); });
  stop.addEventListener("click", ()=> { window.speechSynthesis.cancel(); });

  pdfBtn.addEventListener("click", ()=> generatePDF(latestList));
  refresh.addEventListener("click", ()=> loadAndRender());

  // initial load
  await loadAndRender();
}

async function loadAndRender() {
  document.getElementById("news").innerHTML = "<p style='text-align:center;color:#55616a;'>роЪрпЖропрпНродро┐роХро│рпН родро░ро╡ро┐ро▒роХрпНроХроорпН роЪрпЖропрпНропрокрпНрокроЯрпБроХро┐ро▒родрпБтАж</p>";
  try {
    latestList = await loadAll();
    renderNews(latestList);
  } catch (e) {
    console.error(e);
    document.getElementById("news").innerHTML = "<p style='text-align:center;color:#b33;'>роЪрпЖропрпНродро┐роХро│рпИ роПро▒рпНро▒ ро╡рпЖро▒рпНро▒ро┐ропро┐ро▓рпНро▓рпИ. роЗрогрпИропродро│родрпНродрпИроЪрпН роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.</p>";
  }
}

init();

</script>
</body>
</html>
