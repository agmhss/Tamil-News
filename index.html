<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="utf-8" />
<title>அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி — தினசரி தமிழ் செய்திகள்</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  body{margin:0;background:#f0f7ff;font-family:'Noto Sans Tamil',sans-serif;color:#000}
  header{background:#2b6cb0;color:#fff;padding:18px;text-align:center;font-size:20px;font-weight:700}
  .subheader{text-align:center;padding:8px;font-size:15px;color:#083358}
  .controls{padding:12px;text-align:center}
  button{padding:10px 16px;margin:5px;border:none;border-radius:8px;background:#2b6cb0;color:#fff;cursor:pointer;font-size:15px}
  button.ghost{background:#fff;color:#2b6cb0;border:1px solid #2b6cb0}
  #newsWrap{max-width:900px;margin:auto;padding:15px}
  .sectionTitle{font-size:19px;font-weight:700;color:#2b6cb0;margin:25px 0 12px;text-align:center}
  .card{background:#fff;padding:16px;border-radius:10px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
  .title{font-weight:700;font-size:16px;margin-bottom:8px;line-height:1.35}
  .desc{line-height:1.45;color:#444;font-size:14.5px}
  .meta{font-size:12px;color:#777;margin-top:8px}
  a.readmore{color:#2b6cb0;text-decoration:none;font-weight:600;font-size:13px}

  /* மிக முக்கியம்: html2pdf blank ஆக வராமல் இருக்க இந்த முறை 100% வேலை செய்யும் */
  #printable{
    position:fixed !important;top:-9999px !important;left:-9999px !important;
    width:180mm;padding:15mm 16mm;background:white;
    font-size:13.5px;line-height:1.42;
    opacity:0;pointer-events:none;
  }
  #printable h1{font-size:20px;text-align:center;margin:0 0 6px;color:#2b6cb0;font-weight:700}
  #printable .date{text-align:center;margin:0 0 14px;color:#444;font-size:13.5px;font-weight:600}
  #printable .sec{font-size:16.5px;font-weight:700;color:#2b6cb0;text-align:center;margin:16px 0 7px}
  #printable .pdCard{margin:7px 0;padding:7px;background:#fbfbff;border-radius:5px}
  #printable .num{font-weight:700;color:#2b6cb0;margin-right:6px}
  #printable strong{font-size:13.8px}
  #printable small{float:right;color:#666;font-size:11.5px}
</style>
</head>
<body>
<header>அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி, பட்டீஸ்வரம் — தினசரி தமிழ் செய்திகள்</header>
<div class="subheader">மாணவர்களுக்கான முக்கிய செய்திகள் (10 மட்டும்)</div>

<div class="controls">
  <button id="playBtn">செய்தியை படிக்க</button>
  <button id="pauseBtn" class="ghost">நிறுத்த</button>
  <button id="stopBtn" class="ghost">முழுவதும் நிறுத்து</button>
  <button id="pdfBtn">PDF பதிவிறக்க</button>
  <button id="refreshBtn" class="ghost">புதுப்பி</button>
</div>

<div id="newsWrap"><div id="news">செய்திகள் ஏற்றப்படுகிறது…</div></div>
<div id="printable"></div>

<script>
const FEEDS = {
  tamilnadu: "https://news.google.com/rss/search?q=when:24h+தமிழ்நாடு+செய்தி&hl=ta&gl=IN&ceid=IN:ta",
  national:  "https://news.google.com/rss/search?q=when:24h+இந்தியா+செய்தி+-%E0%AE%A4%E0%AE%AE%E0%AE%BF%E0%AE%B4%E0%AF%8D%E0%AE%A8%E0%AE%BE%E0%AE%9F%E0%AF%81&hl=ta&gl=IN&ceid=IN:ta",
  world:     "https://news.google.com/rss/search?q=when:24h+உலக+செய்தி&hl=ta&gl=IN&ceid=IN:ta"
};

async function fetchFeed(url) {
  try {
    const r = await fetch("https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(url));
    if (!r.ok) return [];
    const j = await r.json();
    return (j.items || []).map(x => ({
      title: x.title?.trim() || "தலைப்பு இல்லை",
      desc: (x.description || "").replace(/<\/?[^>]+>/gi,"").replace(/\s+/g," ").trim().substring(0,170) + "…",
      link: x.link,
      source: (x.author || new URL(x.link).hostname.replace("www.","").split(".")[0]).toUpperCase()
    }));
  } catch(e) { return []; }
}

function isGood(n) {
  const t = (n.title + " " + n.desc).toLowerCase();
  const bad = ["கொலை","தற்கொலை","Head Lines","தலைப்புச்","செய்திகள்","தாக்குதல்","வன்முறை","குண்டு","பாலியல்","அரசியல்","கைது","போராட்டம்","விபத்து","ஊழல்","மரணம்"];
  return !bad.some(w => t.includes(w));
}

async function getNews() {
  const [a,b,c] = await Promise.all([fetchFeed(FEEDS.tamilnadu), fetchFeed(FEEDS.national), fetchFeed(FEEDS.world)]);
  return {
    tamilnadu: a.filter(isGood).slice(0,5),
    national:  b.filter(isGood).slice(0,3),
    world:     c.filter(isGood).slice(0,2)
  };
}

function showNews(data) {
  const wrap = document.getElementById("news"); wrap.innerHTML = "";
  const sec = (title, list) => {
    if (!list.length) return;
    const s = document.createElement("div");
    s.innerHTML = `<div class="sectionTitle">${title}</div>`;
    list.forEach(i => {
      s.innerHTML += `<div class="card">
        <div class="title">${i.title}</div>
        <div class="desc">${i.desc}</div>
        <div class="meta">${i.source}</div>
      </div>`;
    });
    wrap.appendChild(s);
  };
  sec("தமிழ்நாடு செய்திகள்", data.tamilnadu);
  sec("தேசிய செய்திகள்", data.national);
  sec("உலக செய்திகள்", data.world);
}

/* PDF — இப்போது blank வரவே வராது */
function makePDF(data) {
  const p = document.getElementById("printable");
  p.innerHTML = `
    <h1>அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி<br>தினசரி தமிழ் செய்திகள்</h1>
    <div class="date">${new Date().toLocaleDateString("ta-IN", {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</div>
  `;

  const add = (title, list) => {
    if (!list.length) return;
    p.innerHTML += `<div class="sec">${title}</div>`;
    list.forEach((x, i) => {
      p.innerHTML += `<div class="pdCard">
        <span class="num">${i+1}.</span><strong>${x.title}</strong><br>
        ${x.desc}<br><small>— ${x.source}</small><div style="clear:both"></div>
      </div>`;
    });
  };

  add("தமிழ்நாடு செய்திகள்", data.tamilnadu);
  add("தேசிய செய்திகள்", data.national);
  add("உலக செய்திகள்", data.world);

  // html2pdf க்கு சரியாக ரெண்டர் செய்ய இந்த இரண்டு வரி முக்கியம்
  p.style.position = "static";
  p.style.top = "0";

  const opt = {
    margin: 0,
    filename: `தினசரி_செய்தி_${new Date().toLocaleDateString('en-CA')}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2.4, useCORS: true, letterRendering: true, backgroundColor: '#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(p).save().then(() => {
    p.style.position = "fixed";
    p.style.top = "-9999px";
  });
}

/* பொத்தான்கள் */
let allNews = {};
document.getElementById("refreshBtn").onclick = async () => {
  document.getElementById("news").innerHTML = "செய்திகள் ஏற்றப்படுகிறது…";
  allNews = await getNews();
  showNews(allNews);
};
document.getElementById("pdfBtn").onclick = () => makePDF(allNews);
document.getElementById("playBtn").onclick = () => {
  speechSynthesis.cancel();
  const txt = Array.from(document.querySelectorAll(".title")).map(t => t.textContent).join(". ");
  const utter = new SpeechSynthesisUtterance("நண்பர்களே, இன்றைய முக்கிய செய்திகள். " + txt);
  utter.lang = "ta-IN";
  speechSynthesis.speak(utter);
};
document.getElementById("pauseBtn").onclick = () => speechSynthesis.pause();
document.getElementById("stopBtn").onclick = () => speechSynthesis.cancel();

/* தானாக ஏற்றும் */
(async () => {
  allNews = await getNews();
  showNews(allNews);
})();
</script>
</body>
</html>
