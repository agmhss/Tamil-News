<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="utf-8">
<title>அண்ணா அரசு பள்ளி - தினசரி செய்தி</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  body{font-family:'Noto Sans Tamil',sans-serif;background:#f0f7ff;margin:0;padding:0}
  header{background:#1e40af;color:#fff;padding:20px;text-align:center;font-size:21px;font-weight:700}
  .btn{padding:12px 20px;margin:8px;border:none;border-radius:8px;background:#1d4ed8;color:#fff;font-size:16px;cursor:pointer}
  .btn2{background:#fff;color:#1d4ed8;border:2px solid #1d4ed8}
  #news{padding:15px;max-width:900px;margin:auto}
  .sec{margin:25px 0 10px;font-size:19px;font-weight:700;color:#1d4ed8;text-align:center}
  .card{background:#fff;padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .title{font-size:16.5px;font-weight:700;margin-bottom:8px}
  .desc{line-height:1.5;color:#333}

/* மிக முக்கியமான தீர்வு — இதனால்தான் blank வந்தது */
#printable {
  position:fixed;top:0;left:0;width:210mm;height:297mm;
  background:white;padding:18mm 15mm;
  font-size:14px;line-height:1.45;
  transform:scale(1);transform-origin:0 0;
  opacity:1 !important;visibility:visible !important;
}
</style>
</head>
<body>
<header>அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி, பட்டீஸ்வரம்<br><small>தினசரி தமிழ் செய்திகள்</small></header>

<div style="text-align:center;padding:10px">
  <button class="btn" id="pdfBtn">PDF பதிவிறக்கு</button>
  <button class="btn btn2" id="refreshBtn">புதுப்பி</button>
</div>

<div id="news">செய்திகள் ஏற்றப்படுகிறது…</div>

<!-- இதுதான் PDF-க்கு உள்ளே போகும் உண்மையான பக்கம் -->
<div id="printable"></div>

<script>
async function getFeed(url){
  try{
    const r=await fetch("https://api.rss2json.com/v1/api.json?rss_url="+encodeURIComponent(url));
    if(!r.ok) return [];
    const j=await r.json();
    return j.items.map(x=>({
      title:x.title||"",
      desc:(x.description||"").replace(/<[^>]*>/g,"").replace(/\s+/g," ").trim().substring(0,190)+"…",
      source:(new URL(x.link).hostname.replace("www.","").split(".")[0]).toUpperCase()
    }));
  }catch(e){return []}
}

async function load(){
  const [tn, nat, intl] = await Promise.all([
    getFeed("https://news.google.com/rss/search?q=when:24h+தமிழ்நாடு+செய்தி&hl=ta&gl=IN&ceid=IN:ta"),
    getFeed("https://news.google.com/rss/search?q=when:24h+இந்தியா+செய்தி+-%E0%AE%A4%E0%AE%AE%E0%AE%BF%E0%AE%B4%E0%AF%8D%E0%AE%A8%E0%AE%BE%E0%AE%9F%E0%AF%81&hl=ta&gl=IN&ceid=IN:ta"),
    getFeed("https://news.google.com/rss/search?q=when:24h+உலக+செய்தி&hl=ta&gl=IN&ceid=IN:ta")
  ]);

  const good = arr => arr.filter(x=>{
    const t=(x.title+" "+x.desc).toLowerCase();
    const bad=["கொலை","தற்கொலை","தாக்குதல்","வன்முறை","பாலியல்","அரசியல்","கைது","போராட்டம்","விபத்து","மரணம்"];
    return !bad.some(w=>t.includes(w));
  });

  return {
    tn: good(tn).slice(0,5),
    nat: good(nat).slice(0,3),
    intl: good(intl).slice(0,2)
  };
}

function show(data){
  const n=document.getElementById("news"); n.innerHTML="";
  const sec=(t,a)=>{if(a.length){n.innerHTML+=`<div class="sec">${t}</div>`;a.forEach(x=>{n.innerHTML+=`<div class="card"><div class="title">${x.title}</div><div class="desc">${x.desc}</div><small style="color:#666;float:right">— ${x.source}</small><div style="clear:both"></div></div>`})}}
  sec("தமிழ்நாடு செய்திகள்",data.tn);
  sec("தேசிய செய்திகள்",data.nat);
  sec("உலக செய்திகள்",data.intl);
}

/* இந்த function மட்டும் சரியாக இருந்தால் PDF blank வரவே வராது */
function createPDF(data){
  const p=document.getElementById("printable");
  p.innerHTML = `
    <h1 style="text-align:center;color:#1d4ed8;font-size:22px;margin-bottom:8px">
      அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி<br>தினசரி தமிழ் செய்திகள்
    </h1>
    <div style="text-align:center;margin-bottom:20px;color:#444;font-weight:600">
      ${new Date().toLocaleDateString("ta-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}
    </div>`;

  const add=(title,list)=>{if(list.length){p.innerHTML+=`<div style="font-size:17px;font-weight:700;color:#1d4ed8;text-align:center;margin:18px 0 8px">${title}</div>`;list.forEach((x,i)=>{p.innerHTML+=`<div style="margin:10px 0"><span style="font-weight:700;color:#1d4ed8">${i+1}.</span> <strong>${x.title}</strong><br>${x.desc}<br><small style="float:right;color:#666">— ${x.source}</small><div style="clear:both"></div></div>`})}}
  add("தமிழ்நாடு செய்திகள்",data.tn);
  add("தேசிய செய்திகள்",data.nat);
  add("உலக செய்திகள்",data.intl);

  // இதுதான் ரகசியம் — html2pdf க்கு உண்மையான visible element கொடுக்க வேண்டும்
  html2pdf().set({
    margin:0,
    filename:`தினசரி_செய்தி_${new Date().toLocaleDateString('en-CA')}.pdf`,
    html2canvas:{scale:2.5, useCORS:true, letterRendering:true},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  }).from(p).save();
}

let newsData={tn:[],nat:[],intl:[]};

document.getElementById("refreshBtn").onclick=async()=>{document.getElementById("news").innerHTML="செய்திகள் ஏற்றப்படுகிறது…";newsData=await load();show(newsData);}
document.getElementById("pdfBtn").onclick=()=>{createPDF(newsData);}

// தொடக்கத்தில் ஒரு முறை ஏற்று
(async()=>{newsData=await load();show(newsData);})();
</script>
</body>
</html>
