<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி — தினசரி தமிழ் செய்திகள்</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<style>
  :root{--accent:#2b6cb0;--bg:#f0f7ff;--card:#ffffff;--muted:#55616a;}
  html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:"Noto Sans Tamil",sans-serif;color:#0b1220;}
  header{background:var(--accent);color:#fff;padding:18px 12px;text-align:center;font-size:20px;font-weight:700;}
  .subheader{text-align:center;padding:10px 12px;color:#083358;font-weight:600;}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:12px;}
  button,input[type=range]{font-size:15px;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;border:1px solid rgba(0,0,0,0.08);cursor:pointer;}
  button.ghost{background:#fff;color:var(--accent);border:1px solid rgba(43,91,165,0.12);}
  #speedWrap{display:flex;align-items:center;gap:8px;}
  #newsWrap{max-width:900px;margin:12px auto;padding:12px;}
  .sectionTitle{font-size:19px;font-weight:700;color:var(--accent);margin:20px 0 12px;padding-bottom:6px;border-bottom:2px solid rgba(43,91,165,0.2);}
  .card{background:var(--card);border-radius:10px;padding:15px;box-shadow:0 4px 12px rgba(15,30,50,0.08);margin-bottom:14px;}
  .title{font-weight:700;font-size:16px;margin-bottom:6px;color:#0b1220;line-height:1.3;}
  .desc{font-size:14.5px;color:var(--muted);line-height:1.45;margin-bottom:8px;}
  .meta{font-size:12px;color:#7a8a93;}
  a.readmore{display:inline-block;margin-top:6px;color:var(--accent);text-decoration:none;font-weight:600;font-size:13px;}
  #printable{padding:20px;background:white;font-size:14.5px;line-height:1.5;}
  #printable h1{font-size:21px;text-align:center;margin-bottom:8px;}
  #printable .date{text-align:center;color:#444;margin-bottom:20px;}
  #printable .sec{font-size:17px;font-weight:700;color:var(--accent);margin:18px 0 10px;border-bottom:1px solid #ddd;padding-bottom:4px;}
  #printable .pdCard{margin:12px 0;padding:10px;border-left:4px solid var(--accent);background:#fafcff;}
  #printable .num{font-weight:700;color:var(--accent);}
  @media (max-width:480px){
    header{font-size:18px;}
    .title{font-size:15px;}
    .desc{font-size:13.5px;}
  }
</style>
</head>
<body>
<header>அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி — தினசரி தமிழ் செய்திகள்</header>
<div class="subheader">மாணவர்களுக்கான முக்கிய செய்திகள் (10 மட்டும்)</div>

<div class="controls">
  <button id="playBtn">நிகழ் செய்தியை படிக்க</button>
  <button id="pauseBtn" class="ghost">நிறுத்த</button>
  <button id="stopBtn" class="ghost">நிறுத்து</button>
  <button id="pdfBtn">PDF பதிவிறக்க</button>
  <button id="refreshBtn" class="ghost">புதுப்பி</button>
</div>

<div id="newsWrap">
  <div id="news">செய்திகள் ஏற்றப்படுகிறது…</div>
</div>

<div id="printable" style="display:none;"></div>

<script>
// மிக முக்கியமான தமிழ் செய்தி RSS (Google News - நவம்பர் 2025 வரை சிறப்பாக வேலை செய்கிறது)
const FEEDS = {
  tamilnadu: "https://news.google.com/rss/search?q=when:24h+தமிழ்நாடு+செய்தி&hl=ta&gl=IN&ceid=IN:ta",
  national:  "https://news.google.com/rss/search?q=when:24h+இந்தியா+செய்தி+-%E0%AE%A4%E0%AE%AE%E0%AE%BF%E0%AE%B4%E0%AF%8D%E0%AE%A8%E0%AE%BE%E0%AE%9F%E0%AF%81&hl=ta&gl=IN&ceid=IN:ta",
  world:     "https://news.google.com/rss/search?q=when:24h+உலக+செய்தி&hl=ta&gl=IN&ceid=IN:ta"
};

async function fetchFeed(url) {
  const proxy = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(url);
  try {
    const r = await fetch(proxy);
    if (!r.ok) return [];
    const j = await r.json();
    return (j.items || []).map(it => ({
      title: it.title?.trim() || "",
      desc: (it.description || "").replace(/<\/?[^>]+>/gi, "").trim(),
      link: it.link,
      date: it.pubDate,
      source: it.author || new URL(it.link).hostname.replace("www.","").split('.')[0]
    }));
  } catch(e) {
    console.warn("Feed failed:", url);
    return [];
  }
}

function isStudentFriendly(item) {
  const text = (item.title + " " + item.desc).toLowerCase();
  const bad = ["கொலை","தற்கொலை","தாக்குதல்","வன்முறை","குண்டு","பாலியல்","அரசியல்","கைது","போராட்டம்","விபத்து","ஊழல்","Headlines","தலைப்பு செய்திகள் "];
  const good = ["கல்வி","மாணவ","பள்ளி","தேர்வு","விளையாட்டு","வெற்றி","விருது","அறிவியல்","தொழில்நுட்பம்","இஸ்ரோ","சுற்றுச்சூழல்","புத்தகம்","ஆராய்ச்சி","மாநாடு","விழா"];
  
  if (bad.some(w => text.includes(w))) return false;
  if (good.some(w => text.includes(w))) return true;
  return true; // neutral செய்திகளும் ஏற்கப்படும்
}

async function loadNews() {
  const [tn, nat, intl] = await Promise.all([
    fetchFeed(FEEDS.tamilnadu),
    fetchFeed(FEEDS.national),
    fetchFeed(FEEDS.world)
  ]);

  const final = {
    tamilnadu: tn.filter(isStudentFriendly).slice(0,5),
    national:  nat.filter(isStudentFriendly).slice(0,3),
    world:     intl.filter(isStudentFriendly).slice(0,2)
  };

  return final;
}

function render(news) {
  const wrap = document.getElementById("news");
  wrap.innerHTML = "";

  if (!news.tamilnadu.length && !news.national.length && !news.world.length) {
    wrap.innerHTML = "<p style='text-align:center;color:#b33;'>செய்திகள் கிடைக்கவில்லை. மீண்டும் முயலவும்.</p>";
    return;
  }

  const createSection = (title, items) => {
    if (!items.length) return;
    const sec = document.createElement("section");
    const h = document.createElement("div");
    h.className = "sectionTitle";
    h.textContent = title;
    sec.appendChild(h);
    items.forEach((it, i) => {
      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <div class="title">${it.title}</div>
        <div class="desc">${it.desc}</div>
        <div class="meta">${it.source} • ${it.date ? new Date(it.date).toLocaleDateString("ta-IN") : ""}</div>
        <a href="${it.link}" target="_blank" rel="noopener" class="readmore">மேலும் படிக்க ↗</a>
      `;
      sec.appendChild(card);
    });
    wrap.appendChild(sec);
  };

  createSection("தமிழ்நாடு செய்திகள்", news.tamilnadu);
  createSection("தேசிய செய்திகள்", news.national);
  createSection("உலக செய்திகள்", news.world);
}

// PDF - ஒரு பக்கத்திற்கு சரியாக வரும் வகையில்
function makePDF(news) {
  const p = document.getElementById("printable");
  p.innerHTML = `
    <h1>அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி<br>தினசரி தமிழ் செய்திகள்</h1>
    <div class="date">${new Date().toLocaleDateString("ta-IN", {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</div>
  `;

  const addSec = (title, items) => {
    if (!items.length) return;
    p.innerHTML += `<div class="sec">${title}</div>`;
    items.forEach((it, i) => {
      p.innerHTML += `
        <div class="pdCard">
          <span class="num">${i+1}.</span> <strong>${it.title}</strong><br>
          ${it.desc}<br>
          <small style="color:#666;">— ${it.source}</small>
        </div>
      `;
    });
  };

  addSec("தமிழ்நாடு செய்திகள்", news.tamilnadu);
  addSec("தேசிய செய்திகள்", news.national);
  addSec("உலக செய்திகள்", news.world);

  const opt = {
    margin: [12, 12, 12, 12],
    filename: `தினசரி_செய்தி_${new Date().toLocaleDateString('en-CA')}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(p).save();
  p.innerHTML = "";
}

// TTS
let voices = [];
function loadVoices() { voices = window.speechSynthesis.getVoices(); }
window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function speak() {
  window.speechSynthesis.cancel();
  const text = "நண்பர்களே, அண்ணா அரசு மாதிரி மேல்நிலை பள்ளி வழங்கும் தினசரி தமிழ் செய்திகள், இன்றைய முக்கிய செய்திகள். " +
    Array.from(document.querySelectorAll('.title')).map(t => t.textContent).join(". ") +
    ". இவை உங்களுக்கு பயனுள்ளதாக இருக்கும் என்று நம்புகிறோம்.";
  
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "ta-IN";
  const tamilVoice = voices.find(v => v.lang.startsWith("ta")) || voices.find(v => v.lang.includes("in")) || voices[0];
  if (tamilVoice) utter.voice = tamilVoice;
  utter.rate = 0.95;
  window.speechSynthesis.speak(utter);
}

// Events
let latestNews = {};
document.getElementById("refreshBtn").onclick = async () => {
  document.getElementById("news").innerHTML = "செய்திகள் ஏற்றப்படுகிறது…";
  latestNews = await loadNews();
  render(latestNews);
};
document.getElementById("playBtn").onclick = speak;
document.getElementById("pauseBtn").onclick = () => speechSynthesis.pause();
document.getElementById("stopBtn").onclick = () => speechSynthesis.cancel();
document.getElementById("pdfBtn").onclick = () => makePDF(latestNews);

// Initial load
(async () => {
  latestNews = await loadNews();
  render(latestNews);
})();
</script>
</body>
</html>
